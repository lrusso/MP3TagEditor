<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>MP3 Tag Editor</title>
    <link
      rel="icon"
      sizes="16x16"
      type="image/png"
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAABi0lEQVR4AZSQMUgDQRBFxyNNohFiGosQROwEFRsxCbjpVISQQsRCbKzEWtPFdMFasLERC7EK0cburoiCjWhhEJEgwUJBDCIqQrhz/8oc6+USyMG/3Z2d/2Z2DOryW9vICalttnUFkEaxv1u02Iy1IyCVKwkkQdLsVpUQd98WALNtG2Zis+wkt07M90B05q5vCizSYb4ANqts+Qs3X6kRGBSxjydzbzFjduzAa5Z+iv3cFyLNZ6veG6emExTluYRTnk+oZ/zrQDeviBEaHxqAn6qhaYEOcPgOBP+G6FC+NJsSLkA3w3hoPdCYBGAvjfkvo18uRFfRSXewCCiAbkaQjR4Irij5cq5W/ikApo0At60bsccdtB6qklhIU2R0AkclBZC7ghQh2Vsd8ZvHN1quHVH48pRqxwfUuL1GWEkBLnYymKgvBFlceXhplSC/DsgLQVWY9cqoDrV0gERIh+BsGHY6/llXb0ZVFu5Y6gl8wMoQmCvFrIUYKupCjNUCwAUgbKYeKlAbZc8q1i8AAAD//0Pf5mMAAAAGSURBVAMAYPC6FDxwffIAAAAASUVORK5CYII="
    >
    <meta name="theme-color" content="#000">
    <meta name="keywords" content="mp3, tag, editor">
    <meta name="description" content="MP3 Tag Editor.">
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, minimum-scale=1.0"
    >
    <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
          user-select: none;
          -webkit-user-select: none;
          -moz-user-select: none;
      }
      body {
          font-family: Arial;
          background: #000;
          font-size: 14px;
          color: #000;
          overflow: hidden;
          height: 100vh;
      }
      .app-container {
          display: none;
          grid-template-columns: 320px 1fr;
          height: 100vh;
          background: #f5f5f5;
      }
      .left-panel {
          background: #e8e8e8;
          border-right: 1px solid #ccc;
          display: flex;
          flex-direction: column;
          overflow-y: auto;
      }
      .tag-fields {
          padding: 8px;
          flex: 1;
      }
      .field-row {
          display: flex;
          gap: 8px;
          margin-bottom: 4px;
      }
      .field-group {
          flex: 1;
          display: flex;
          flex-direction: column;
      }
      .field-group.small {
          flex: 0 0 80px;
      }
      .field-group label {
          font-size: 14px;
          color: #000;
          margin-bottom: 2px;
          font-weight: normal;
      }
      .field-group input,
      .field-group textarea {
          width: 100%;
          padding: 4px 6px;
          border: 1px solid #999;
          border-radius: 0;
          font-size: 14px;
          background: white;
          font-family: inherit;
      }
      .field-group input:focus,
      .field-group textarea:focus {
          outline: none;
          border-color: #4a90d9;
          box-shadow: 0 0 0 1px #4a90d9;
      }
      .field-group textarea {
          resize: vertical;
          min-height: 50px;
      }
      .track-number-row {
          display: flex;
          align-items: center;
          gap: 4px;
      }
      .track-number-row input {
          width: 35px;
          text-align: center;
      }
      .track-number-row span {
          font-size: 14px;
          color: #000;
      }
      .cover-art-section {
          border-top: 1px solid #ccc;
          padding: 8px;
          background: #e8e8e8;
      }
      .cover-art-wrapper {
          position: relative;
          border: 1px solid #999;
          margin-bottom: 8px;
      }
      .cover-art-container {
          width: 100%;
          aspect-ratio: 1;
          max-height: 300px;
          background: #fff;
          overflow: hidden;
      }
      .cover-art-container img {
          width: 100%;
          height: 100%;
      }
      .no-cover {
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          display: flex;
          align-items: center;
          justify-content: center;
          background: #fff;
          color: #808080;
          font-size: 14px;
      }
      .cover-art-info {
          background: white;
          padding: 4px 6px;
          font-size: 14px;
          color: #666;
      }
      .cover-info-row {
          display: flex;
          justify-content: center;
          padding: 1px 0;
          cursor: default;
      }
      .cover-actions {
          display: flex;
          gap: 4px;
      }
      .btn-small {
          width: 50%;
          padding: 5px 12px;
          font-size: 14px;
          border: 1px solid #999;
          background: linear-gradient(to bottom, #f8f8f8, #e0e0e0);
          cursor: pointer;
          border-radius: 3px;
      }
      .btn-small:hover {
          background: linear-gradient(to bottom, #fff, #e8e8e8);
      }
      .btn-small:active {
          background: linear-gradient(to bottom, #d0d0d0, #e0e0e0);
      }
      .center-panel {
          display: flex;
          flex-direction: column;
          background: white;
          overflow: hidden;
      }
      .file-list-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 8px;
          background: #e8e8e8;
          border-bottom: 1px solid #ccc;
      }
      .file-input-wrapper {
          position: relative;
      }
      .file-input-wrapper input[type="file"] {
          position: absolute;
          opacity: 0;
          width: 100%;
          height: 100%;
          cursor: pointer;
      }
      .file-input-wrapper:hover .btn-save {
          background: linear-gradient(to bottom, #fff, #e8e8e8);
      }
      .file-actions {
          display: flex;
          gap: 8px;
      }
      .btn-save, .btn-clear {
          padding: 5px 15px;
          font-size: 14px;
          border: 1px solid #999;
          background: linear-gradient(to bottom, #f8f8f8, #e0e0e0);
          cursor: pointer;
          border-radius: 3px;
      }
      .btn-save:hover, .btn-clear:hover {
          background: linear-gradient(to bottom, #fff, #e8e8e8);
      }
      .file-list-container {
          flex: 1;
          overflow: auto;
          background: white;
      }
      .file-list {
          width: 100%;
          display: table;
          font-size: 14px;
      }
      .file-list-head,
      .file-list-body {
          display: table-row-group;
      }
      .file-list-head {
          position: sticky;
          top: 0;
          z-index: 10;
      }
      .file-list-head .file-row > div {
          background: linear-gradient(to bottom, #f0f0f0, #d8d8d8);
          border: 1px solid #bbb;
          border-top: none;
          padding: 6px 8px;
          font-weight: 500;
          white-space: nowrap;
          cursor: pointer;
          user-select: none;
      }
      .file-list-head .file-row > div:hover {
          background: linear-gradient(to bottom, #f8f8f8, #e0e0e0);
      }
      .file-row {
          display: table-row;
      }
      .file-row > div {
          display: table-cell;
          border-left: 0 !important;
      }
      .file-list-body .file-row {
          cursor: pointer;
      }
      .file-list-body .file-row > div {
          border: 1px solid #ddd;
          border-top: none;
          padding: 4px 8px;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
      }
      .file-list-body .file-row:nth-child(even) {
          background: #f9f9f9;
      }
      .file-list-body .file-row:hover {
          background: #e8f0fc;
      }
      .file-list-body .file-row.selected {
          background: #4a90d9;
          color: white;
      }
      .file-list-body .file-row.selected > div {
          border-color: #357abd;
      }
      .file-list {
          table-layout: fixed;
      }
      .col-filename {
          width: 25%;
          min-width: 150px;
      }
      .col-title, .col-artist, .col-album {
          width: 20%;
          min-width: 120px;
      }
      .col-track {
          width: 75px;
          min-width: 50px;
          text-align: left;
      }
      ::-webkit-scrollbar {
          width: 12px;
          height: 12px;
      }
      ::-webkit-scrollbar-track {
          background: #f0f0f0;
      }
      ::-webkit-scrollbar-thumb {
          background: #c0c0c0;
          border: 2px solid #f0f0f0;
          border-radius: 6px;
      }
      ::-webkit-scrollbar-thumb:hover {
          background: #a0a0a0;
      }
      .multiple-values {
          color: #999;
          font-style: italic;
      }
      .multiple-values::placeholder {
          color: #999;
          font-style: italic;
      }
      .contact-link {
          text-decoration: none;
          color: #357abd;
      }
      .contact-link:hover {
          filter: brightness(1.4);
      }
      .hidden {
          display: none;
      }
      button {
        color: #000;
      }
      #fileInput {
        display: none;
      }
      @media (max-width: 1023px) {
          .app-container {
              grid-template-columns: 1fr;
              grid-template-rows: auto 1fr;
          }
          .left-panel {
              border-right: none;
              border-bottom: 1px solid #ccc;
              max-height: 40vh;
          }
          .cover-art-container img {
              object-fit: contain;
          }
      }
      .pleasewait{position:fixed;width:64px;height:64px;left:0;right:0;top:0;bottom:0;margin:auto auto;border:0}
      .lds-spinner{color:#fff;display:inline-block;position:relative;width:64px;height:64px}
      .lds-spinner div{transform-origin:32px 32px;animation:lds-spinner 1.2s linear infinite}
      .lds-spinner div:after{content:" ";display:block;position:absolute;top:3px;left:29px;width:5px;height:14px;border-radius:20%;background:#fff}
      .lds-spinner div:nth-child(1){transform:rotate(0deg);animation-delay:-1.1s}
      .lds-spinner div:nth-child(2){transform:rotate(30deg);animation-delay:-1s}
      .lds-spinner div:nth-child(3){transform:rotate(60deg);animation-delay:-.9s}
      .lds-spinner div:nth-child(4){transform:rotate(90deg);animation-delay:-.8s}
      .lds-spinner div:nth-child(5){transform:rotate(120deg);animation-delay:-.7s}
      .lds-spinner div:nth-child(6){transform:rotate(150deg);animation-delay:-.6s}
      .lds-spinner div:nth-child(7){transform:rotate(180deg);animation-delay:-.5s}
      .lds-spinner div:nth-child(8){transform:rotate(210deg);animation-delay:-.4s}
      .lds-spinner div:nth-child(9){transform:rotate(240deg);animation-delay:-.3s}
      .lds-spinner div:nth-child(10){transform:rotate(270deg);animation-delay:-.2s}
      .lds-spinner div:nth-child(11){transform:rotate(300deg);animation-delay:-.1s}
      .lds-spinner div:nth-child(12){transform:rotate(330deg);animation-delay:0s}
      @keyframes lds-spinner{0%{opacity:1}to{opacity:0}}
    </style>
  </head>
  <body>
    <div class="pleasewait">
      <div class="lds-spinner">
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
      </div>
    </div>
    <div class="app-container">
      <div class="left-panel">
        <div class="tag-fields">
          <div class="field-row">
            <div class="field-group">
              <label for="title"></label>
              <input type="text" id="title" placeholder="" tabindex="2">
            </div>
          </div>
          <div class="field-row">
            <div class="field-group">
              <label for="artist"></label>
              <input type="text" id="artist" placeholder="">
            </div>
            <div class="field-group small">
              <label for="trackNumber"></label>
              <div class="track-number-row">
                <input type="text" id="trackNumber" placeholder="">
                <span></span>
                <input type="text" id="trackTotal" placeholder="">
              </div>
            </div>
          </div>
          <div class="field-row">
            <div class="field-group">
              <label for="albumArtist"></label>
              <input type="text" id="albumArtist" placeholder="">
            </div>
            <div class="field-group small">
              <label for="discNumber"></label>
              <div class="track-number-row">
                <input type="text" id="discNumber" placeholder="">
                <span></span>
                <input type="text" id="discTotal" placeholder="">
              </div>
            </div>
          </div>
          <div class="field-row">
            <div class="field-group">
              <label for="album"></label>
              <input type="text" id="album" placeholder="">
            </div>
          </div>
          <div class="field-row">
            <div class="field-group">
              <label for="composer"></label>
              <input type="text" id="composer" placeholder="">
            </div>
            <div class="field-group small">
              <label for="year"></label>
              <input type="text" id="year" placeholder="">
            </div>
          </div>
          <div class="field-row">
            <div class="field-group">
              <label for="genre"></label>
              <input type="text" id="genre" placeholder="">
            </div>
            <div class="field-group small">
              <label for="grouping"></label>
              <input type="text" id="grouping" placeholder="">
            </div>
          </div>
        </div>
        <div class="cover-art-section">
          <div class="cover-art-wrapper">
            <div class="cover-art-container" id="coverArtContainer">
              <div class="no-cover"></div>
            </div>
            <div class="cover-art-info" id="coverArtInfo">
              <div class="cover-info-row">
                <span id="coverDimensions">&nbsp;</span>
              </div>
              <div class="cover-info-row">
                <span id="coverSize">&nbsp;</span>
              </div>
              <div class="cover-info-row">
                <span id="coverFormat">&nbsp;</span>
              </div>
            </div>
          </div>
          <input type="file" id="coverInput" accept="image/*" class="hidden">
          <div class="cover-actions">
            <button id="addCoverBtn" class="btn-small"></button>
            <button id="removeCoverBtn" class="btn-small"></button>
          </div>
        </div>
      </div>
      <div class="center-panel">
        <div class="file-list-header">
          <div class="file-input-wrapper">
            <input type="file" id="fileInput" accept=".mp3" multiple tabindex="-1">
            <button id="addFilesBtn" class="btn-save" tabindex="1"></button>
          </div>
          <div>
            <a
              href="https://www.lrusso.com"
              class="contact-link"
              target="_blank"
            ></a>
          </div>
          <div class="file-actions">
            <button id="saveBtn" class="btn-save"></button>
          </div>
        </div>
        <div class="file-list-container">
          <div class="file-list" id="fileList">
            <div class="file-list-head">
              <div class="file-row">
                <div class="col-filename"></div>
                <div class="col-title"></div>
                <div class="col-artist"></div>
                <div class="col-album"></div>
                <div class="col-track"></div>
                <div class="col-track"></div>
              </div>
            </div>
            <div class="file-list-body" id="fileListBody"></div>
          </div>
        </div>
      </div>
    </div>
    <script>
      var APP_STRINGS = {
        en: {
          track_title: "Track Title",
          track_artist: "Track Artist",
          track: "Track",
          of: "of",
          album_artist: "Album Artist",
          disc: "Disc",
          album: "Album",
          composer: "Composer",
          year: "Year",
          genre: "Genre",
          grouping: "Grouping",
          no_cover_art: "No Cover Art",
          add: "Add",
          remove: "Remove",
          add_mp3_files: "Add MP3 Files",
          download_all: "Download All",
          filename: "Filename",
          title: "Title",
          artist: "Artist",
          total: "Total",
          multiple_values: "Multiple values",
          by_author: "By LRusso.com",
        },
        es: {
          track_title: "T\xEDtulo de pista",
          track_artist: "Artista de pista",
          track: "Pista",
          of: "de",
          album_artist: "Artista del \xE1lbum",
          disc: "Disco",
          album: "\xC1lbum",
          composer: "Compositor",
          year: "A\xF1o",
          genre: "G\xE9nero",
          grouping: "Agrupaci\xF3n",
          no_cover_art: "Sin car\xE1tula",
          add: "Agregar",
          remove: "Eliminar",
          add_mp3_files: "Agregar archivos MP3",
          download_all: "Descargar todo",
          filename: "Nombre",
          title: "T\xEDtulo",
          artist: "Artista",
          total: "Total",
          multiple_values: "Valores m\xFAltiples",
          by_author: "Por LRusso.com",
        },
      }

      var USER_LANG = window.navigator.language.substring(0, 2).toLowerCase()
      var GET_APP_STRING = APP_STRINGS[USER_LANG] || APP_STRINGS["en"]

      function t(stringName) {
        return GET_APP_STRING[stringName] || ""
      }

      function getKeys(obj) {
        var keys = []
        for (var key in obj) {
          if (obj.hasOwnProperty(key)) {
            keys.push(key)
          }
        }
        return keys
      }

      function MP3TagEditor() {
        this.files = []
        this.selectedIndices = []
        this.lastSelectedIndex = -1
        this.focusedIndex = -1
        this.selectionAnchor = -1
        this.sortColumn = 0
        this.isLoading = false
        this.initializeElements()
        this.attachEventListeners()
        this.applyTranslations()
        this.sortByColumn(0)
        this.appContainer.style.display = "grid"
      }

      MP3TagEditor.prototype.applyTranslations = function () {
        // labels
        document.querySelector('label[for="title"]').innerText = t("track_title")
        document.querySelector('label[for="artist"]').innerText = t("track_artist")
        document.querySelector('label[for="trackNumber"]').innerText = t("track")
        document.querySelector('label[for="albumArtist"]').innerText =
          t("album_artist")
        document.querySelector('label[for="discNumber"]').innerText = t("disc")
        document.querySelector('label[for="album"]').innerText = t("album")
        document.querySelector('label[for="composer"]').innerText = t("composer")
        document.querySelector('label[for="year"]').innerText = t("year")
        document.querySelector('label[for="genre"]').innerText = t("genre")
        document.querySelector('label[for="grouping"]').innerText = t("grouping")

        // "of" spans
        var ofSpans = document.querySelectorAll(".track-number-row span")
        for (var i = 0; i < ofSpans.length; i++) {
          ofSpans[i].innerText = t("of")
        }

        // cover art section
        var noCoverEl = document.querySelector(".no-cover")
        if (noCoverEl) {
          noCoverEl.innerText = t("no_cover_art")
        }
        this.addCoverBtn.innerText = t("add")
        this.removeCoverBtn.innerText = t("remove")

        // file list header buttons
        this.addFilesBtn.innerText = t("add_mp3_files")
        this.saveBtn.innerText = t("download_all")

        // author link
        document.querySelector(".contact-link").innerText = t("by_author")
      }

      MP3TagEditor.prototype.initializeElements = function () {
        this.pleaseWait = document.querySelector(".pleasewait")
        this.appContainer = document.querySelector(".app-container")
        this.fileInput = document.getElementById("fileInput")
        this.fileListBody = document.getElementById("fileListBody")
        this.coverArtContainer = document.getElementById("coverArtContainer")
        this.coverInput = document.getElementById("coverInput")
        this.addCoverBtn = document.getElementById("addCoverBtn")
        this.removeCoverBtn = document.getElementById("removeCoverBtn")
        this.saveBtn = document.getElementById("saveBtn")
        this.addFilesBtn = document.getElementById("addFilesBtn")

        this.fields = {
          title: document.getElementById("title"),
          artist: document.getElementById("artist"),
          album: document.getElementById("album"),
          albumArtist: document.getElementById("albumArtist"),
          year: document.getElementById("year"),
          trackNumber: document.getElementById("trackNumber"),
          trackTotal: document.getElementById("trackTotal"),
          discNumber: document.getElementById("discNumber"),
          discTotal: document.getElementById("discTotal"),
          genre: document.getElementById("genre"),
          composer: document.getElementById("composer"),
          grouping: document.getElementById("grouping"),
        }

        this.coverInfo = {
          dimensions: document.getElementById("coverDimensions"),
          size: document.getElementById("coverSize"),
          format: document.getElementById("coverFormat"),
        }
      }

      MP3TagEditor.prototype.showLoading = function () {
        this.isLoading = true
        this.pleaseWait.style.display = "block"
        this.appContainer.style.opacity = "0.5"

        // disable all interactive elements
        this.fileInput.disabled = true
        this.addFilesBtn.disabled = true
        this.saveBtn.disabled = true
        this.addCoverBtn.disabled = true
        this.removeCoverBtn.disabled = true
        this.coverInput.disabled = true

        var self = this
        var fieldKeys = getKeys(this.fields)
        for (var i = 0; i < fieldKeys.length; i++) {
          var key = fieldKeys[i]
          if (self.fields[key]) {
            self.fields[key].disabled = true
          }
        }

        // disable file list row clicks
        var rows = this.fileListBody.querySelectorAll(".file-row")
        for (var j = 0; j < rows.length; j++) {
          rows[j].style.pointerEvents = "none"
        }

        // disable column header clicks
        var headers = document.querySelectorAll(".file-list-head .file-row > div")
        for (var k = 0; k < headers.length; k++) {
          headers[k].style.pointerEvents = "none"
        }
      }

      MP3TagEditor.prototype.hideLoading = function () {
        this.isLoading = false
        this.pleaseWait.style.display = "none"
        this.appContainer.style.opacity = "1"

        // re-enable all interactive elements
        this.fileInput.disabled = false
        this.addFilesBtn.disabled = false
        this.saveBtn.disabled = false
        this.addCoverBtn.disabled = false
        this.removeCoverBtn.disabled = false
        this.coverInput.disabled = false

        var self = this
        var fieldKeys = getKeys(this.fields)
        for (var i = 0; i < fieldKeys.length; i++) {
          var key = fieldKeys[i]
          if (self.fields[key]) {
            self.fields[key].disabled = false
          }
        }

        // re-enable file list row clicks
        var rows = this.fileListBody.querySelectorAll(".file-row")
        for (var j = 0; j < rows.length; j++) {
          rows[j].style.pointerEvents = ""
        }

        // re-enable column header clicks
        var headers = document.querySelectorAll(".file-list-head .file-row > div")
        for (var k = 0; k < headers.length; k++) {
          headers[k].style.pointerEvents = ""
        }
      }

      MP3TagEditor.prototype.attachEventListeners = function () {
        var self = this

        this.fileInput.addEventListener("change", function (e) {
          self.handleFilesSelect(e.target.files)
          e.target.value = ""
          this.blur()
        })

        this.addFilesBtn.addEventListener("click", function () {
          self.fileInput.click()
          this.blur()
        })

        this.coverInput.addEventListener("change", function (e) {
          self.handleCoverSelect(e)
          this.blur()
        })

        this.addCoverBtn.addEventListener("click", function () {
          self.coverInput.click()
          this.blur()
        })

        this.removeCoverBtn.addEventListener("click", function () {
          self.removeCoverArt()
          this.blur()
        })

        this.saveBtn.addEventListener("click", function () {
          self.downloadAllFiles()
          this.blur()
        })

        // field change listeners
        var fieldKeys = getKeys(this.fields)
        for (var i = 0; i < fieldKeys.length; i++) {
          var key = fieldKeys[i]
          if (self.fields[key]) {
            self.fields[key].addEventListener("input", function () {
              this.className = this.className.replace(" multiple-values", "")
              this.placeholder = ""
              self.updateCurrentFileTags()
            })
          }
        }

        // header click for sorting
        var headers = document.querySelectorAll(".file-list-head .file-row > div")
        for (var j = 0; j < headers.length; j++) {
          ;(function (index) {
            headers[index].addEventListener("click", function () {
              self.sortByColumn(index)
            })
          })(j)
        }

        // keyboard navigation for file list
        document.addEventListener("keydown", function (e) {
          // block keyboard shortcuts during loading
          if (self.isLoading) {
            e.preventDefault()
            return
          }

          var activeElement = document.activeElement
          var tagName = activeElement.tagName.toLowerCase()

          if (
            tagName === "input" ||
            tagName === "textarea" ||
            tagName === "button"
          ) {
            return
          }

          if (self.files.length === 0) {
            return
          }

          var keyCode = e.keyCode || e.which
          var currentIndex = self.focusedIndex >= 0 ? self.focusedIndex : 0

          if (keyCode === 40) {
            // arrowdown
            e.preventDefault()
            var newIndex = currentIndex + 1
            if (newIndex < self.files.length) {
              if (e.shiftKey) {
                self.shiftArrowSelection(newIndex, 1)
              } else {
                self.selectFile(newIndex, e)
              }
            }
          } else if (keyCode === 38) {
            // arrowup
            e.preventDefault()
            var newIndex = currentIndex - 1
            if (newIndex >= 0) {
              if (e.shiftKey) {
                self.shiftArrowSelection(newIndex, -1)
              } else {
                self.selectFile(newIndex, e)
              }
            }
          } else if (keyCode === 65 && (e.ctrlKey || e.metaKey)) {
            // ctrl/cmd + a = select all
            e.preventDefault()
            self.selectedIndices = []
            for (var k = 0; k < self.files.length; k++) {
              self.selectedIndices.push(k)
            }
            self.lastSelectedIndex = self.files.length - 1
            self.updateSelectionUI()
            self.displayFileTags()
          }
        })
      }

      MP3TagEditor.prototype.handleFilesSelect = function (fileList) {
        var self = this
        var newFiles = []
        for (var i = 0; i < fileList.length; i++) {
          newFiles.push(fileList[i])
        }

        var pending = newFiles.length
        var fileDatas = []

        if (pending === 0) {
          return
        }

        this.showLoading()

        for (var j = 0; j < newFiles.length; j++) {
          ;(function (file) {
            self.readFileAsArrayBuffer(file, function (buffer) {
              var fileData = {
                file: file,
                fileName: file.name,
                buffer: buffer,
                tags: {},
                coverArt: null,
                modified: false,
              }
              self.parseFileTags(fileData)
              fileDatas.push(fileData)

              pending = pending - 1
              if (pending === 0) {
                self.files = self.files.concat(fileDatas)
                self.sortByColumn(self.sortColumn)
                if (self.files.length > 0 && self.selectedIndices.length === 0) {
                  self.selectFile(0)
                }
                self.hideLoading()
              }
            })
          })(newFiles[j])
        }
      }

      MP3TagEditor.prototype.readFileAsArrayBuffer = function (file, callback) {
        var reader = new FileReader()
        reader.onload = function (e) {
          callback(e.target.result)
        }
        reader.onerror = function () {
          console.log("Failed to read file")
        }
        reader.readAsArrayBuffer(file)
      }

      MP3TagEditor.prototype.parseFileTags = function (fileData) {
        var view = new DataView(fileData.buffer)
        fileData.tags = {
          title: "",
          artist: "",
          album: "",
          albumArtist: "",
          year: "",
          trackNumber: "",
          trackTotal: "",
          discNumber: "",
          discTotal: "",
          genre: "",
          composer: "",
          grouping: "",
        }

        if (this.hasID3v2Tag(view)) {
          this.parseID3v2(view, fileData)
        }
      }

      MP3TagEditor.prototype.hasID3v2Tag = function (view) {
        return (
          view.byteLength >= 10 &&
          String.fromCharCode(view.getUint8(0)) === "I" &&
          String.fromCharCode(view.getUint8(1)) === "D" &&
          String.fromCharCode(view.getUint8(2)) === "3"
        )
      }

      MP3TagEditor.prototype.parseID3v2 = function (view, fileData) {
        var version = view.getUint8(3)
        var size = this.synchsafeToInt(view, 6)
        var offset = 10
        var headerEnd = 10 + size

        while (offset < headerEnd && offset + 10 <= view.byteLength) {
          var frameId = this.readFrameId(view, offset)
          if (frameId === "\0\0\0\0") {
            break
          }

          var frameSize =
            version === 4
              ? this.synchsafeToInt(view, offset + 4)
              : this.readInt(view, offset + 4, 4)

          if (frameSize > 0 && offset + 10 + frameSize <= view.byteLength) {
            var frameData = new Uint8Array(fileData.buffer, offset + 10, frameSize)
            this.processFrame(frameId, frameData, fileData)
          }

          offset = offset + 10 + frameSize
        }
      }

      MP3TagEditor.prototype.readFrameId = function (view, offset) {
        return String.fromCharCode(
          view.getUint8(offset),
          view.getUint8(offset + 1),
          view.getUint8(offset + 2),
          view.getUint8(offset + 3)
        )
      }

      MP3TagEditor.prototype.processFrame = function (frameId, data, fileData) {
        if (frameId === "APIC") {
          if (!fileData.coverArt) {
            this.processPictureFrame(data, fileData)
          }
          return
        }

        if (data.length === 0) {
          return
        }

        var encoding = data[0]
        var textData = this.sliceUint8Array(data, 1)
        var text = this.decodeText(textData, encoding)

        var frameMap = {
          TIT2: "title",
          TPE1: "artist",
          TALB: "album",
          TPE2: "albumArtist",
          TYER: "year",
          TDRC: "year",
          TRCK: "track",
          TPOS: "disc",
          TCON: "genre",
          TCOM: "composer",
          TIT1: "grouping",
        }

        if (frameMap[frameId]) {
          if (frameId === "TRCK") {
            var trackParts = text.split("/")
            fileData.tags.trackNumber = trackParts[0] || ""
            fileData.tags.trackTotal = trackParts[1] || ""
          } else if (frameId === "TPOS") {
            var discParts = text.split("/")
            fileData.tags.discNumber = discParts[0] || ""
            fileData.tags.discTotal = discParts[1] || ""
          } else {
            fileData.tags[frameMap[frameId]] = text
          }
        }
      }

      MP3TagEditor.prototype.sliceUint8Array = function (arr, start, end) {
        if (end === undefined) {
          end = arr.length
        }
        var result = new Uint8Array(end - start)
        for (var i = start; i < end; i++) {
          result[i - start] = arr[i]
        }
        return result
      }

      MP3TagEditor.prototype.processPictureFrame = function (data, fileData) {
        try {
          if (data.length < 5) {
            return
          }

          var offset = 0
          var encoding = data[offset]
          offset = offset + 1

          while (offset < data.length && data[offset] !== 0) {
            offset = offset + 1
          }
          offset = offset + 1

          if (offset >= data.length) {
            return
          }
          offset = offset + 1

          if (encoding === 0 || encoding === 3) {
            while (offset < data.length && data[offset] !== 0) {
              offset = offset + 1
            }
            offset = offset + 1
          } else if (encoding === 1 || encoding === 2) {
            while (
              offset < data.length - 1 &&
              !(data[offset] === 0 && data[offset + 1] === 0)
            ) {
              offset = offset + 1
            }
            offset = offset + 2
          }

          if (offset >= data.length) {
            return
          }

          var imageData = this.sliceUint8Array(data, offset)
          var detectedMimeType = "image/jpeg"
          if (
            imageData[0] === 0x89 &&
            imageData[1] === 0x50 &&
            imageData[2] === 0x4e &&
            imageData[3] === 0x47
          ) {
            detectedMimeType = "image/png"
          } else if (imageData[0] === 0xff && imageData[1] === 0xd8) {
            detectedMimeType = "image/jpeg"
          }

          var blob = new Blob([imageData], { type: detectedMimeType })
          fileData.coverArt = {
            data: imageData,
            blob: blob,
            url: URL.createObjectURL(blob),
            mimeType: detectedMimeType,
            size: imageData.length,
          }
        } catch (error) {
          console.log("Error processing cover art:", error)
        }
      }

      MP3TagEditor.prototype.decodeText = function (data, encoding) {
        try {
          var text = ""
          var i
          if (encoding === 0) {
            // iso-8859-1
            for (i = 0; i < data.length; i++) {
              if (data[i] !== 0) {
                text = text + String.fromCharCode(data[i])
              }
            }
          } else if (encoding === 3) {
            // utf-8
            text = this.decodeUtf8(data)
          } else if (encoding === 1) {
            // utf-16 with bom (le)
            var startOffset = 0
            if (data.length >= 2 && data[0] === 0xff && data[1] === 0xfe) {
              startOffset = 2
            }
            for (i = startOffset; i < data.length - 1; i = i + 2) {
              if (data[i] !== 0 || data[i + 1] !== 0) {
                var charCode = data[i] | (data[i + 1] << 8)
                text = text + String.fromCharCode(charCode)
              }
            }
          } else if (encoding === 2) {
            // utf-16 be
            var startOffset = 0
            if (data.length >= 2 && data[0] === 0xfe && data[1] === 0xff) {
              startOffset = 2
            }
            for (i = startOffset; i < data.length - 1; i = i + 2) {
              if (data[i] !== 0 || data[i + 1] !== 0) {
                var charCode = (data[i] << 8) | data[i + 1]
                text = text + String.fromCharCode(charCode)
              }
            }
          }
          return text.replace(/^\s+|\s+$/g, "")
        } catch (error) {
          console.log("Decoding error:", error)
          return ""
        }
      }

      MP3TagEditor.prototype.decodeUtf8 = function (data) {
        var result = ""
        var i = 0
        while (i < data.length) {
          var byte1 = data[i]
          if (byte1 === 0) {
            i = i + 1
            continue
          }
          if (byte1 < 0x80) {
            // single byte character (ascii)
            result = result + String.fromCharCode(byte1)
            i = i + 1
          } else if ((byte1 & 0xe0) === 0xc0) {
            // two byte character
            if (i + 1 < data.length) {
              var byte2 = data[i + 1]
              var codePoint = ((byte1 & 0x1f) << 6) | (byte2 & 0x3f)
              result = result + String.fromCharCode(codePoint)
              i = i + 2
            } else {
              i = i + 1
            }
          } else if ((byte1 & 0xf0) === 0xe0) {
            // three byte character
            if (i + 2 < data.length) {
              var byte2 = data[i + 1]
              var byte3 = data[i + 2]
              var codePoint =
                ((byte1 & 0x0f) << 12) | ((byte2 & 0x3f) << 6) | (byte3 & 0x3f)
              result = result + String.fromCharCode(codePoint)
              i = i + 3
            } else {
              i = i + 1
            }
          } else if ((byte1 & 0xf8) === 0xf0) {
            // four byte character (surrogate pairs for characters outside bmp)
            if (i + 3 < data.length) {
              var byte2 = data[i + 1]
              var byte3 = data[i + 2]
              var byte4 = data[i + 3]
              var codePoint =
                ((byte1 & 0x07) << 18) |
                ((byte2 & 0x3f) << 12) |
                ((byte3 & 0x3f) << 6) |
                (byte4 & 0x3f)
              // convert to surrogate pair
              codePoint = codePoint - 0x10000
              var highSurrogate = 0xd800 + (codePoint >> 10)
              var lowSurrogate = 0xdc00 + (codePoint & 0x3ff)
              result = result + String.fromCharCode(highSurrogate, lowSurrogate)
              i = i + 4
            } else {
              i = i + 1
            }
          } else {
            // invalid utf-8, skip byte
            i = i + 1
          }
        }
        return result
      }

      MP3TagEditor.prototype.synchsafeToInt = function (view, offset) {
        return (
          (view.getUint8(offset) << 21) |
          (view.getUint8(offset + 1) << 14) |
          (view.getUint8(offset + 2) << 7) |
          view.getUint8(offset + 3)
        )
      }

      MP3TagEditor.prototype.readInt = function (view, offset, bytes) {
        var result = 0
        for (var i = 0; i < bytes; i++) {
          result = (result << 8) | view.getUint8(offset + i)
        }
        return result
      }

      MP3TagEditor.prototype.renderFileList = function () {
        var self = this
        while (this.fileListBody.firstChild) {
          this.fileListBody.removeChild(this.fileListBody.firstChild)
        }

        for (var i = 0; i < this.files.length; i++) {
          ;(function (fileData, index) {
            var row = document.createElement("div")
            row.className = "file-row"
            row.setAttribute("data-index", index)

            if (self.selectedIndices.indexOf(index) >= 0) {
              row.className = row.className + " selected"
            }

            var filenameCell = document.createElement("div")
            filenameCell.textContent = fileData.fileName
            filenameCell.className = "col-filename"

            var titleCell = document.createElement("div")
            titleCell.textContent = fileData.tags.title || ""
            titleCell.className = "col-title"

            var artistCell = document.createElement("div")
            artistCell.textContent = fileData.tags.artist || ""
            artistCell.className = "col-artist"

            var albumCell = document.createElement("div")
            albumCell.textContent = fileData.tags.album || ""
            albumCell.className = "col-album"

            var trackNumberCell = document.createElement("div")
            trackNumberCell.textContent = fileData.tags.trackNumber || ""
            trackNumberCell.className = "col-track"

            var trackTotalCell = document.createElement("div")
            trackTotalCell.textContent = fileData.tags.trackTotal || ""
            trackTotalCell.className = "col-track"

            row.appendChild(filenameCell)
            row.appendChild(titleCell)
            row.appendChild(artistCell)
            row.appendChild(albumCell)
            row.appendChild(trackNumberCell)
            row.appendChild(trackTotalCell)

            row.addEventListener("click", function (e) {
              self.selectFile(index, e)
            })

            self.fileListBody.appendChild(row)
          })(this.files[i], i)
        }
      }

      MP3TagEditor.prototype.selectFile = function (index, event) {
        if (index < 0 || index >= this.files.length) {
          return
        }

        var ctrlKey = event && (event.ctrlKey || event.metaKey)
        var shiftKey = event && event.shiftKey

        if (shiftKey && this.lastSelectedIndex >= 0) {
          var anchor =
            this.selectionAnchor >= 0 ? this.selectionAnchor : this.lastSelectedIndex
          var start = Math.min(anchor, index)
          var end = Math.max(anchor, index)
          this.selectedIndices = []
          for (var i = start; i <= end; i++) {
            this.selectedIndices.push(i)
          }
          this.focusedIndex = index
          if (this.selectionAnchor === -1) {
            this.selectionAnchor = this.lastSelectedIndex
          }
        } else if (ctrlKey) {
          var existingIndex = this.selectedIndices.indexOf(index)
          if (existingIndex >= 0) {
            this.selectedIndices.splice(existingIndex, 1)
          } else {
            this.selectedIndices.push(index)
          }
          this.lastSelectedIndex = index
          this.focusedIndex = index
          this.selectionAnchor = -1
        } else {
          this.selectedIndices = [index]
          this.lastSelectedIndex = index
          this.focusedIndex = index
          this.selectionAnchor = -1
        }

        this.selectedIndices.sort(function (a, b) {
          return a - b
        })

        this.updateSelectionUI()
        this.displayFileTags()
      }

      MP3TagEditor.prototype.extendSelection = function (index) {
        if (index < 0 || index >= this.files.length) {
          return
        }

        if (this.selectedIndices.indexOf(index) === -1) {
          this.selectedIndices.push(index)
        }

        this.selectedIndices.sort(function (a, b) {
          return a - b
        })

        this.updateSelectionUI()
        this.scrollToIndex(index)
        this.displayFileTags()
      }

      MP3TagEditor.prototype.shiftArrowSelection = function (newIndex, direction) {
        if (newIndex < 0 || newIndex >= this.files.length) {
          return
        }

        // initialize anchor if this is the first shift+arrow press
        if (this.selectionAnchor === -1) {
          this.selectionAnchor = this.focusedIndex >= 0 ? this.focusedIndex : 0
        }

        var anchor = this.selectionAnchor

        // determine if we're shrinking the selection (moving toward anchor)
        var currentIndex = this.focusedIndex
        var movingTowardAnchor =
          (direction === 1 && currentIndex < anchor) ||
          (direction === -1 && currentIndex > anchor)

        if (movingTowardAnchor && currentIndex !== anchor) {
          // shrinking: remove the current index from selection
          var existingIndex = this.selectedIndices.indexOf(currentIndex)
          if (existingIndex !== -1) {
            this.selectedIndices.splice(existingIndex, 1)
          }
        } else {
          // extending: add the new index to selection
          if (this.selectedIndices.indexOf(newIndex) === -1) {
            this.selectedIndices.push(newIndex)
          }
        }

        this.selectedIndices.sort(function (a, b) {
          return a - b
        })

        this.focusedIndex = newIndex
        this.updateSelectionUI()
        this.scrollToIndex(newIndex)
        this.displayFileTags()
      }

      MP3TagEditor.prototype.scrollToIndex = function (index) {
        var row = this.fileListBody.querySelector('[data-index="' + index + '"]')
        if (row) {
          var container = this.fileListBody.parentElement.parentElement
          var header =
            this.fileListBody.parentElement.querySelector(".file-list-head")
          var headerHeight = header ? header.offsetHeight : 0
          var rowRect = row.getBoundingClientRect()
          var containerRect = container.getBoundingClientRect()

          if (rowRect.top < containerRect.top + headerHeight) {
            container.scrollTop =
              container.scrollTop - (containerRect.top + headerHeight - rowRect.top)
          } else if (rowRect.bottom > containerRect.bottom) {
            container.scrollTop =
              container.scrollTop + rowRect.bottom - containerRect.bottom
          }
        }
      }

      MP3TagEditor.prototype.updateSelectionUI = function () {
        var self = this
        var rows = this.fileListBody.querySelectorAll(".file-row")
        for (var i = 0; i < rows.length; i++) {
          var rowIndex = parseInt(rows[i].getAttribute("data-index"), 10)
          if (self.selectedIndices.indexOf(rowIndex) >= 0) {
            if (rows[i].className.indexOf("selected") === -1) {
              rows[i].className = rows[i].className + " selected"
            }
          } else {
            rows[i].className = rows[i].className.replace(" selected", "")
          }
        }

        if (this.selectedIndices.length > 0) {
          var lastIndex = this.selectedIndices[this.selectedIndices.length - 1]
          var row = this.fileListBody.querySelector(
            '[data-index="' + lastIndex + '"]'
          )
          if (row) {
            var container = this.fileListBody.parentElement.parentElement
            var header =
              this.fileListBody.parentElement.querySelector(".file-list-head")
            var headerHeight = header ? header.offsetHeight : 0
            var rowRect = row.getBoundingClientRect()
            var containerRect = container.getBoundingClientRect()

            if (rowRect.top < containerRect.top + headerHeight) {
              container.scrollTop =
                container.scrollTop -
                (containerRect.top + headerHeight - rowRect.top)
            } else if (rowRect.bottom > containerRect.bottom) {
              container.scrollTop =
                container.scrollTop + rowRect.bottom - containerRect.bottom
            }
          }
        }
      }

      MP3TagEditor.prototype.displayFileTags = function (skipCoverArt) {
        var self = this

        if (this.selectedIndices.length === 0) {
          var fieldKeys = getKeys(this.fields)
          for (var i = 0; i < fieldKeys.length; i++) {
            var key = fieldKeys[i]
            if (self.fields[key]) {
              self.fields[key].value = ""
              self.fields[key].placeholder = ""
              self.fields[key].className = self.fields[key].className.replace(
                " multiple-values",
                ""
              )
            }
          }
          if (!skipCoverArt) {
            this.displayCoverArt(null)
          }
          return
        }

        if (this.selectedIndices.length === 1) {
          var fileData = this.files[this.selectedIndices[0]]
          var fieldKeys = getKeys(this.fields)
          for (var i = 0; i < fieldKeys.length; i++) {
            var key = fieldKeys[i]
            if (self.fields[key] && fileData.tags.hasOwnProperty(key)) {
              self.fields[key].value = fileData.tags[key] || ""
              self.fields[key].placeholder = ""
              self.fields[key].className = self.fields[key].className.replace(
                " multiple-values",
                ""
              )
            }
          }
          if (!skipCoverArt) {
            this.displayCoverArt(fileData)
          }
          return
        }

        var fieldKeys = getKeys(this.fields)
        for (var i = 0; i < fieldKeys.length; i++) {
          var key = fieldKeys[i]
          if (!self.fields[key]) {
            continue
          }

          var firstValue = this.files[this.selectedIndices[0]].tags[key] || ""
          var allSame = true

          for (var j = 1; j < this.selectedIndices.length; j++) {
            var fileData = this.files[this.selectedIndices[j]]
            var currentValue = fileData.tags[key] || ""
            if (currentValue !== firstValue) {
              allSame = false
              break
            }
          }

          if (allSame) {
            self.fields[key].value = firstValue
            self.fields[key].placeholder = ""
            self.fields[key].className = self.fields[key].className.replace(
              " multiple-values",
              ""
            )
          } else {
            self.fields[key].value = ""
            var isNumberField =
              key === "trackNumber" ||
              key === "trackTotal" ||
              key === "discNumber" ||
              key === "discTotal"
            var placeholder = t("multiple_values")
            if (isNumberField) {
              placeholder = "--"
            } else if (key === "year") {
              placeholder = "----"
            }
            self.fields[key].placeholder = placeholder
            if (self.fields[key].className.indexOf("multiple-values") === -1) {
              self.fields[key].className =
                self.fields[key].className + " multiple-values"
            }
          }
        }

        if (!skipCoverArt) {
          this.displayCoverArtMultiple()
        }
      }

      MP3TagEditor.prototype.displayCoverArtMultiple = function () {
        var self = this

        while (this.coverArtContainer.firstChild) {
          this.coverArtContainer.removeChild(this.coverArtContainer.firstChild)
        }

        var existingNoCover =
          this.coverArtContainer.parentElement.querySelector(".no-cover")
        if (existingNoCover) {
          existingNoCover.parentElement.removeChild(existingNoCover)
        }

        var firstCover = null
        var allSameCover = true

        for (var i = 0; i < this.selectedIndices.length && allSameCover; i++) {
          var fileData = this.files[this.selectedIndices[i]]
          if (i === 0) {
            firstCover = fileData.coverArt
          } else if (firstCover === null && fileData.coverArt !== null) {
            allSameCover = false
          } else if (firstCover !== null && fileData.coverArt === null) {
            allSameCover = false
          } else if (firstCover !== null && fileData.coverArt !== null) {
            if (firstCover.size !== fileData.coverArt.size) {
              allSameCover = false
            } else {
              var firstData = firstCover.data
              var currentData = fileData.coverArt.data
              for (var j = 0; j < firstData.length && allSameCover; j++) {
                if (firstData[j] !== currentData[j]) {
                  allSameCover = false
                }
              }
            }
          }
        }

        if (allSameCover && firstCover) {
          var img = document.createElement("img")
          img.alt = "Cover Art"
          img.onload = function () {
            self.coverInfo.dimensions.textContent =
              img.naturalWidth + " x " + img.naturalHeight
            self.coverInfo.size.textContent = self.formatFileSize(firstCover.size)
            self.coverInfo.format.textContent = firstCover.mimeType
              .split("/")[1]
              .toUpperCase()
          }
          img.src = firstCover.url
          this.coverArtContainer.appendChild(img)
        } else if (!allSameCover) {
          var multipleValues = document.createElement("div")
          multipleValues.className = "no-cover"
          multipleValues.innerText = t("multiple_values")
          this.coverArtContainer.appendChild(multipleValues)
          this.coverInfo.dimensions.textContent = "\xA0"
          this.coverInfo.size.textContent = "\xA0"
          this.coverInfo.format.textContent = "\xA0"
        } else {
          var noCover = document.createElement("div")
          noCover.className = "no-cover"
          noCover.innerText = t("no_cover_art")
          this.coverArtContainer.appendChild(noCover)
          this.coverInfo.dimensions.textContent = "\xA0"
          this.coverInfo.size.textContent = "\xA0"
          this.coverInfo.format.textContent = "\xA0"
        }
      }

      MP3TagEditor.prototype.displayCoverArt = function (fileData) {
        var self = this

        while (this.coverArtContainer.firstChild) {
          this.coverArtContainer.removeChild(this.coverArtContainer.firstChild)
        }

        var existingNoCover =
          this.coverArtContainer.parentElement.querySelector(".no-cover")
        if (existingNoCover) {
          existingNoCover.parentElement.removeChild(existingNoCover)
        }

        if (fileData && fileData.coverArt) {
          var img = document.createElement("img")
          img.alt = "Cover Art"
          img.onload = function () {
            self.coverInfo.dimensions.textContent =
              img.naturalWidth + " x " + img.naturalHeight
            self.coverInfo.size.textContent = self.formatFileSize(
              fileData.coverArt.size
            )
            self.coverInfo.format.textContent = fileData.coverArt.mimeType
              .split("/")[1]
              .toUpperCase()
          }
          img.src = fileData.coverArt.url
          this.coverArtContainer.appendChild(img)
        } else {
          var noCover = document.createElement("div")
          noCover.className = "no-cover"
          noCover.innerText = t("no_cover_art")
          this.coverArtContainer.appendChild(noCover)
          this.coverInfo.dimensions.textContent = "\xA0"
          this.coverInfo.size.textContent = "\xA0"
          this.coverInfo.format.textContent = "\xA0"
        }
      }

      MP3TagEditor.prototype.formatFileSize = function (bytes) {
        if (bytes < 1024) {
          return bytes + " B"
        }
        if (bytes < 1024 * 1024) {
          return (bytes / 1024).toFixed(2) + " KB"
        }
        return (bytes / (1024 * 1024)).toFixed(2) + " MB"
      }

      MP3TagEditor.prototype.updateCurrentFileTags = function () {
        if (this.selectedIndices.length === 0) {
          return
        }

        var self = this
        var fieldKeys = getKeys(this.fields)

        for (var j = 0; j < this.selectedIndices.length; j++) {
          var fileData = this.files[this.selectedIndices[j]]

          for (var i = 0; i < fieldKeys.length; i++) {
            var key = fieldKeys[i]
            if (self.fields[key]) {
              var fieldValue = self.fields[key].value
              var hasMultipleValues =
                self.fields[key].placeholder === t("multiple_values")

              if (fieldValue !== "" || !hasMultipleValues) {
                fileData.tags[key] = fieldValue
              }
            }
          }

          fileData.modified = true
        }

        this.renderFileList()
      }

      MP3TagEditor.prototype.handleCoverSelect = function (event) {
        var self = this
        var file = event.target.files[0]
        if (!file) {
          return
        }
        if (this.selectedIndices.length === 0) {
          return
        }

        this.readFileAsArrayBuffer(file, function (arrayBuffer) {
          var imageData = new Uint8Array(arrayBuffer)

          for (var i = 0; i < self.selectedIndices.length; i++) {
            var fileData = self.files[self.selectedIndices[i]]
            var blob = new Blob([arrayBuffer], { type: file.type })

            if (fileData.coverArt && fileData.coverArt.url) {
              URL.revokeObjectURL(fileData.coverArt.url)
            }

            fileData.coverArt = {
              data: imageData,
              blob: blob,
              url: URL.createObjectURL(blob),
              mimeType: file.type,
              size: arrayBuffer.byteLength,
            }

            fileData.modified = true
          }

          self.displayFileTags()
        })

        event.target.value = ""
      }

      MP3TagEditor.prototype.removeCoverArt = function () {
        if (this.selectedIndices.length === 0) {
          return
        }

        for (var i = 0; i < this.selectedIndices.length; i++) {
          var fileData = this.files[this.selectedIndices[i]]
          if (fileData.coverArt && fileData.coverArt.url) {
            URL.revokeObjectURL(fileData.coverArt.url)
          }
          fileData.coverArt = null
          fileData.modified = true
        }

        this.displayFileTags()
      }

      MP3TagEditor.prototype.downloadAllFiles = function () {
        if (this.files.length === 0) {
          return
        }

        var self = this
        var indicesToSave = []
        for (var i = 0; i < this.files.length; i++) {
          indicesToSave.push(i)
        }

        function downloadFile(index) {
          if (index >= indicesToSave.length) {
            return
          }

          var fileData = self.files[indicesToSave[index]]

          try {
            var newMP3Buffer = self.createID3v2Tag(fileData)
            var blob = new Blob([newMP3Buffer], { type: "audio/mpeg" })

            var url = URL.createObjectURL(blob)
            var a = document.createElement("a")
            a.href = url
            a.download = fileData.fileName
            document.body.appendChild(a)
            a.click()
            document.body.removeChild(a)
            URL.revokeObjectURL(url)

            fileData.modified = false
          } catch (error) {
            console.log(error)
          }

          setTimeout(function () {
            downloadFile(index + 1)
          }, 250)
        }

        downloadFile(0)
      }

      MP3TagEditor.prototype.stripAllTags = function (buffer) {
        var view = new DataView(buffer)
        var start = 0
        var end = buffer.byteLength

        // remove id3v2 tag at the beginning
        if (
          end >= 10 &&
          view.getUint8(0) === 0x49 && // 'i'
          view.getUint8(1) === 0x44 && // 'd'
          view.getUint8(2) === 0x33
        ) {
          // '3'
          var tagSize = this.synchsafeToInt(view, 6)
          start = 10 + tagSize
        }

        // remove id3v1 tag at the end (last 128 bytes starting with "tag")
        if (end - start >= 128) {
          var id3v1Offset = end - 128
          if (
            view.getUint8(id3v1Offset) === 0x54 && // 't'
            view.getUint8(id3v1Offset + 1) === 0x41 && // 'a'
            view.getUint8(id3v1Offset + 2) === 0x47
          ) {
            // 'g'
            end = id3v1Offset
          }
        }

        return new Uint8Array(buffer.slice(start, end))
      }

      MP3TagEditor.prototype.createID3v2Tag = function (fileData) {
        var audioData = this.stripAllTags(fileData.buffer)
        var frames = []
        var tags = fileData.tags

        if (tags.title) {
          frames.push(this.createTextFrame("TIT2", tags.title))
        }
        if (tags.artist) {
          frames.push(this.createTextFrame("TPE1", tags.artist))
        }
        if (tags.album) {
          frames.push(this.createTextFrame("TALB", tags.album))
        }
        if (tags.albumArtist) {
          frames.push(this.createTextFrame("TPE2", tags.albumArtist))
        }
        if (tags.year) {
          frames.push(this.createTextFrame("TDRC", tags.year))
        }

        if (tags.trackNumber || tags.trackTotal) {
          var trackValue = tags.trackNumber || ""
          if (tags.trackTotal) {
            trackValue = trackValue + "/" + tags.trackTotal
          }
          frames.push(this.createTextFrame("TRCK", trackValue))
        }

        if (tags.discNumber || tags.discTotal) {
          var discValue = tags.discNumber || ""
          if (tags.discTotal) {
            discValue = discValue + "/" + tags.discTotal
          }
          frames.push(this.createTextFrame("TPOS", discValue))
        }

        if (tags.genre) {
          frames.push(this.createTextFrame("TCON", tags.genre))
        }
        if (tags.composer) {
          frames.push(this.createTextFrame("TCOM", tags.composer))
        }
        if (tags.grouping) {
          frames.push(this.createTextFrame("TIT1", tags.grouping))
        }

        if (fileData.coverArt) {
          frames.push(this.createPictureFrame(fileData.coverArt))
        }

        var framesData = this.concatenateArrays(frames)
        var tagSize = framesData.length
        var header = new Uint8Array(10)

        header[0] = 0x49
        header[1] = 0x44
        header[2] = 0x33
        header[3] = 0x03
        header[4] = 0x00
        header[5] = 0x00

        this.intToSynchsafe(tagSize, header, 6)

        return this.concatenateArrays([header, framesData, audioData])
      }

      MP3TagEditor.prototype.createTextFrame = function (frameId, text) {
        var encoding = 0x01
        var bom = new Uint8Array([0xff, 0xfe])

        var utf16Bytes = []
        for (var i = 0; i < text.length; i++) {
          var code = text.charCodeAt(i)
          utf16Bytes.push(code & 0xff)
          utf16Bytes.push((code >> 8) & 0xff)
        }

        var frameSize = 1 + bom.length + utf16Bytes.length + 2
        var frame = new Uint8Array(10 + frameSize)

        for (var j = 0; j < 4; j++) {
          frame[j] = frameId.charCodeAt(j)
        }

        this.intToBytes(frameSize, frame, 4, 4)

        frame[8] = 0x00
        frame[9] = 0x00

        var offset = 10
        frame[offset] = encoding
        offset = offset + 1

        frame.set(bom, offset)
        offset = offset + bom.length

        for (var k = 0; k < utf16Bytes.length; k++) {
          frame[offset] = utf16Bytes[k]
          offset = offset + 1
        }

        frame[offset] = 0x00
        offset = offset + 1
        frame[offset] = 0x00
        offset = offset + 1

        return frame
      }

      MP3TagEditor.prototype.createPictureFrame = function (coverArt) {
        var mimeType = coverArt.mimeType || "image/jpeg"
        var mimeBytes = []
        for (var i = 0; i < mimeType.length; i++) {
          mimeBytes.push(mimeType.charCodeAt(i))
        }

        var encoding = 0x00
        var pictureType = 0x03
        var description = new Uint8Array([0])

        var frameSize =
          1 + mimeBytes.length + 1 + 1 + description.length + coverArt.data.length
        var frame = new Uint8Array(10 + frameSize)

        frame[0] = 0x41
        frame[1] = 0x50
        frame[2] = 0x49
        frame[3] = 0x43

        this.intToBytes(frameSize, frame, 4, 4)

        frame[8] = 0x00
        frame[9] = 0x00

        var offset = 10
        frame[offset] = encoding
        offset = offset + 1

        for (var j = 0; j < mimeBytes.length; j++) {
          frame[offset] = mimeBytes[j]
          offset = offset + 1
        }
        frame[offset] = 0x00
        offset = offset + 1

        frame[offset] = pictureType
        offset = offset + 1

        frame.set(description, offset)
        offset = offset + description.length

        frame.set(coverArt.data, offset)

        return frame
      }

      MP3TagEditor.prototype.intToSynchsafe = function (value, array, offset) {
        array[offset] = (value >> 21) & 0x7f
        array[offset + 1] = (value >> 14) & 0x7f
        array[offset + 2] = (value >> 7) & 0x7f
        array[offset + 3] = value & 0x7f
      }

      MP3TagEditor.prototype.intToBytes = function (value, array, offset, bytes) {
        for (var i = bytes - 1; i >= 0; i--) {
          array[offset + i] = value & 0xff
          value = value >> 8
        }
      }

      MP3TagEditor.prototype.concatenateArrays = function (arrays) {
        var totalLength = 0
        for (var i = 0; i < arrays.length; i++) {
          totalLength = totalLength + arrays[i].length
        }
        var result = new Uint8Array(totalLength)
        var offset = 0
        for (var j = 0; j < arrays.length; j++) {
          result.set(arrays[j], offset)
          offset = offset + arrays[j].length
        }
        return result
      }

      MP3TagEditor.prototype.sortByColumn = function (columnIndex) {
        var sortKeys = [
          "fileName",
          "title",
          "artist",
          "album",
          "trackNumber",
          "trackTotal",
        ]

        var key = sortKeys[columnIndex]

        if (!key) {
          return
        }

        this.sortColumn = columnIndex

        if (this.files.length === 0) {
          var headers = document.querySelectorAll(".file-list-head .file-row > div")
          var headerTexts = [
            t("filename"),
            t("title"),
            t("artist"),
            t("album"),
            t("track"),
            t("total"),
          ]

          for (var i = 0; i < headers.length; i++) {
            headers[i].textContent = headerTexts[i]
          }
          if (headers[columnIndex]) {
            headers[columnIndex].textContent = headerTexts[columnIndex] + " \u25BC"
          }
          return
        }

        // store references to currently selected file objects before sorting
        var selectedFiles = []
        for (var i = 0; i < this.selectedIndices.length; i++) {
          selectedFiles.push(this.files[this.selectedIndices[i]])
        }
        var focusedFile =
          this.focusedIndex >= 0 ? this.files[this.focusedIndex] : null
        var lastSelectedFile =
          this.lastSelectedIndex >= 0 ? this.files[this.lastSelectedIndex] : null
        var anchorFile =
          this.selectionAnchor >= 0 ? this.files[this.selectionAnchor] : null

        this.files.sort(function (a, b) {
          var valA = key === "fileName" ? a.fileName : a.tags[key] || ""
          var valB = key === "fileName" ? b.fileName : b.tags[key] || ""
          var result = valA.toLowerCase().localeCompare(valB.toLowerCase())
          if (result === 0 && key !== "fileName") {
            result = a.fileName.toLowerCase().localeCompare(b.fileName.toLowerCase())
          }
          return result
        })

        // update indices to point to the same files after sorting
        this.selectedIndices = []
        for (var i = 0; i < selectedFiles.length; i++) {
          var newIndex = this.files.indexOf(selectedFiles[i])
          if (newIndex >= 0) {
            this.selectedIndices.push(newIndex)
          }
        }
        this.selectedIndices.sort(function (a, b) {
          return a - b
        })

        if (focusedFile) {
          this.focusedIndex = this.files.indexOf(focusedFile)
        }
        if (lastSelectedFile) {
          this.lastSelectedIndex = this.files.indexOf(lastSelectedFile)
        }
        if (anchorFile) {
          this.selectionAnchor = this.files.indexOf(anchorFile)
        }

        var headers = document.querySelectorAll(".file-list-head .file-row > div")
        var headerTexts = [
          t("filename"),
          t("title"),
          t("artist"),
          t("album"),
          t("track"),
          t("total"),
        ]

        for (var i = 0; i < headers.length; i++) {
          headers[i].textContent = headerTexts[i]
        }
        if (headers[columnIndex]) {
          headers[columnIndex].textContent = headerTexts[columnIndex] + " \u25BC"
        }

        this.renderFileList()
        this.displayFileTags()
      }

      window.addEventListener("load", function () {
        if (window.top === window.self) {
          var pleaseWait = document.querySelector(".pleasewait")

          pleaseWait.style.display = "none"

          new MP3TagEditor()
        }
      })
    </script>
  </body>
</html>
